
# Adding ClamAV support

To add ClamAV support to Debian `exim-daemon-heavy` package, 
do the following steps:

## Configuration of Clamav

Add/prepend/insert the following line:

File: `/etc/clamav/clamd.conf`
```
AllowSupplementaryGroups true
```
then restart `clamav-daemon` service.


## Configuration of Exim4

These Exim4 settings are for Debian split-file configuration
WITHOUT modifying Debian-supplied config file; we will
add our own config file.

Becareful of the naming convention of Exim4 config file:
only `[-_A-Za-z0-9]` filename pattern allowed; 
absolutely no period symbol.

Create the following files:

File: `/etc/exim4/conf.d/main/98-mysite-clamav`
```ini
av_scanner = clamd:/var/run/clamav/clamd.ctl
```

Create this file and insert the following line:
File: `/etc/exim4/conf.d/acl/acl-custom-my_mta.conf`
```ini
#
# File: acl-custom-my_mta.conf
# Path: /etc/exim4/conf.d/acl
# Title: Custom ACL settings for my MTA
# Description:
#
#
#   This file is a custom Exim config used to hold 
#   all of your own ACL settings that are to be
#   found under the conf.d/acl subdirectory.
#
#   To start making Exim4 daemon use this custom ACL 
#   file, insert a new macro `CHECK_DATA_LOCAL_ACL_FILE`
#   somewhere into the conf.d/main subdirectory.
#
#   To edit a main config file, you would have 
#   to the editing of either file:
#
#   * 00_main-custom-my_mta or
#   * 10_eximt4-config_listmacrosdefs
#
#   Then take the name of this config file that you 
#   are reading and assign it to the macro as followed:
#
#      CHECK_DATA_LOCAL_ACL_FILE = /etc/exim4/conf.d/acl/<name-of-this-file-you-are reading>
#
#   Once done, this custom file of ACL settings can
#   then be picked up and merged for Exim4 daemon to use;
#   also custom file should survive any Debian 
#   package upgrades.
#
#   Incorporate all your custom settings into 
#   `/var/lib/exim4/config.autogenerated` for Exim4 
#   daemon to read, then restart Exim4 service:
#
#       update-exim4.conf -v
#
#       service exim4 restart  # or
#       systemctl restart exim4.service
#
# Tiny Details:
#
#   The logic for the CHECK_DATA_LOCAL_ACL_FILE macro 
#   is in Debian-supplied 
#
#       `40_exim4-config_check_data` file in
#
#          `/etc/eim4/conf.d/main/ directory
#
#   Oh, one more thing, as this is still Debian split-file
#   convention: 
#
#     this file MUST have a `.conf` filetype 
#     suffix.  This is IMPORTANT for update-exim4.conf tool 
#     NOT to re-read this file TWICE: once alongside with
#     many no-period filenames (most starting with 
#     two/three-digit), and once by the INCLUDE statement
#     of this (dotted-filename) file that is found in 
#     the Debian-maintained 40_exim4-config_check_data 
#     config file.
#
# Alternatives:
#   If you ALSO take the route of having your own 
#   custom main file, make the filename of your 
#   custom main config something like:
#
#      00_main-custom-my_mta
#
#   This new macro would go into your own custom main
#   config file or (wincefully) by inserting
#   into Debian's `01_exim4-config_listmacrodefs` file.
#
#   An custom main file would be file-named 
#   as `00_main-custom-my_mta` or something. 
#
#   '00_' meaning that you expect your settings
#   to be picked up and further processed by other 
#   main config files.  
#
#   '99_` means your settings gets processed lastly 
#   and is the final main setting and are not being 
#   subjected to any earlier main config logic.
#
#   This file can be used in either Debian standalone
#   or split-file config mode.
#
#   This file is optional.  The alternative would be
#   to modify Debian-provided main config files
#   and be potentially blown-away by its future 
#   package upgrades.
#

deny
    malware = *
    message = This message was detected as possible malware ($malware_name).
```

Then make ClamAV use Exim4 sockets by executing:
```bash
adduser clamav Debian-exim
chmod -Rf g+w /var/spool/exim4
chmod -Rf g+s /var/spool/exim4
service exim4 restart
```

# Test with exim4 command

```bash
wget -o /tmp/eicar.com.txt https://secure.eicar.org/eicar.com.txt
exim4 -bmalware /tmp/eicar.com.txt
```

# Test Environment (SMTP Protocol)
```bash
telnet localhost 25
helo localhost
from mail: <sender@example.com>
rcpt to: <user@localhost>
data
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
.


```
The SMTP server will send a message about detected malware.

